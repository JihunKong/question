{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "numReplicas": 1,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  },
  "services": [
    {
      "name": "postgres",
      "image": "postgres:15",
      "volumes": ["/var/lib/postgresql/data"],
      "env": {
        "POSTGRES_DB": "question_exchange",
        "POSTGRES_USER": "postgres",
        "POSTGRES_PASSWORD": "${{POSTGRES_PASSWORD}}"
      }
    },
    {
      "name": "redis",
      "image": "redis:7-alpine",
      "volumes": ["/data"]
    },
    {
      "name": "api",
      "deploy": {
        "startCommand": "./start-api.sh",
        "healthcheckPath": "/health",
        "healthcheckInterval": 30,
        "healthcheckTimeout": 10,
        "healthcheckMaxRetries": 5
      },
      "env": {
        "DATABASE_URL": "${{POSTGRES_DATABASE_URL}}",
        "REDIS_URL": "${{REDIS_URL}}",
        "JWT_SECRET": "${{JWT_SECRET}}",
        "AI_SERVICE_URL": "http://ai-processor.railway.internal:3003"
      }
    },
    {
      "name": "web",
      "deploy": {
        "startCommand": "npm run build:web && npm run start:web"
      },
      "env": {
        "NEXT_PUBLIC_API_URL": "${{API_URL}}",
        "NEXT_PUBLIC_WS_URL": "${{REALTIME_URL}}"
      }
    },
    {
      "name": "realtime",
      "deploy": {
        "startCommand": "npm run start:realtime",
        "healthcheckPath": "/health"
      },
      "env": {
        "REDIS_URL": "${{REDIS_URL}}",
        "JWT_SECRET": "${{JWT_SECRET}}"
      }
    },
    {
      "name": "ai-processor",
      "deploy": {
        "startCommand": "cd services/ai-processor && python main.py",
        "healthcheckPath": "/health"
      },
      "env": {
        "DATABASE_URL": "${{POSTGRES_DATABASE_URL}}"
      }
    }
  ]
}